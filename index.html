<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Arena Latina â€” Unit 18: The Horatii and Curiatii</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: #0f0d0b; color: #e8e0d0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
  #root { min-height: 100vh; }
  input:focus { border-color: #d4a843 !important; outline: none; }
  button:hover:not(:disabled) { filter: brightness(1.1); }
  details summary { list-style: none; }
  details summary::-webkit-details-marker { display: none; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
  .fade-in { animation: fadeIn 0.3s ease; }
  @keyframes pulseGold { 0%,100% { box-shadow: 0 0 8px #9a7a3040; } 50% { box-shadow: 0 0 20px #d4a84340; } }
  .pulse-gold { animation: pulseGold 2s infinite; }
  @keyframes streakFire { 0%,100% { transform: scale(1); } 50% { transform: scale(1.15); } }
  .streak-anim { animation: streakFire 0.4s ease; }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useCallback, useRef } = React;

// ============================================================
// THEME
// ============================================================
const T = {
  bg: "#0f0d0b", surface: "#1a1611", surfaceLight: "#24201a", surfaceHover: "#2e2920",
  border: "#3a3328", borderLight: "#4d4435",
  gold: "#d4a843", goldDim: "#9a7a30", goldBright: "#f0c24e", bronze: "#b08040",
  crimson: "#9b2335", crimsonLight: "#c43050", crimsonDark: "#6a1825",
  text: "#e8e0d0", textDim: "#a09888", textMuted: "#6a6258",
  green: "#4a9a5c", greenLight: "#60c078", greenDark: "#2a6a3a",
  red: "#c43050", blue: "#4a7a9a", purple: "#7a5aa0",
};
const SERIF = "'Palatino Linotype','Book Antiqua',Palatino,Georgia,serif";
const SANS = "'Segoe UI',Tahoma,Geneva,Verdana,sans-serif";

// ============================================================
// STORAGE â€” localStorage for GitHub Pages
// ============================================================
function loadUser() {
  try { const d = localStorage.getItem("arena-latina-user"); return d ? JSON.parse(d) : null; } catch { return null; }
}
function saveUser(user) {
  try { localStorage.setItem("arena-latina-user", JSON.stringify(user)); } catch(e) { console.error(e); }
}
function loadLeaderboard() {
  try { const d = localStorage.getItem("arena-latina-lb"); return d ? JSON.parse(d) : {}; } catch { return {}; }
}
function saveLeaderboard(lb) {
  try { localStorage.setItem("arena-latina-lb", JSON.stringify(lb)); } catch(e) { console.error(e); }
}
function updateLeaderboard(username, classGroup, totalXP) {
  const lb = loadLeaderboard();
  lb[username] = { name: username, classGroup, xp: totalXP, updated: Date.now() };
  saveLeaderboard(lb);
}

// ============================================================
// DECLENSION DATA
// ============================================================
const DECLENSIONS = {
  first: {
    label: "1st Declension", nouns: [
      { nom:"puella", stem:"puell", meaning:"girl" }, { nom:"terra", stem:"terr", meaning:"land" },
      { nom:"via", stem:"vi", meaning:"road" }, { nom:"hora", stem:"hor", meaning:"hour" },
      { nom:"ira", stem:"ir", meaning:"anger" }, { nom:"cura", stem:"cur", meaning:"care" },
      { nom:"porta", stem:"port", meaning:"gate" }, { nom:"filia", stem:"fili", meaning:"daughter" },
    ],
    endings: { "nom.sg":"a","acc.sg":"am","gen.sg":"ae","dat.sg":"ae","abl.sg":"Ä","nom.pl":"ae","acc.pl":"Äs","gen.pl":"Ärum","dat.pl":"Ä«s","abl.pl":"Ä«s" }
  },
  second: {
    label: "2nd Declension (-us)", nouns: [
      { nom:"servus", stem:"serv", meaning:"slave" }, { nom:"gladius", stem:"gladi", meaning:"sword" },
      { nom:"filius", stem:"fili", meaning:"son" }, { nom:"murus", stem:"mur", meaning:"wall" },
      { nom:"animus", stem:"anim", meaning:"spirit" }, { nom:"dominus", stem:"domin", meaning:"master" },
    ],
    endings: { "nom.sg":"us","acc.sg":"um","gen.sg":"Ä«","dat.sg":"Å","abl.sg":"Å","nom.pl":"Ä«","acc.pl":"Ås","gen.pl":"Årum","dat.pl":"Ä«s","abl.pl":"Ä«s" }
  },
  secondN: {
    label: "2nd Declension (-um)", nouns: [
      { nom:"bellum", stem:"bell", meaning:"war" }, { nom:"consilium", stem:"consili", meaning:"plan" },
      { nom:"praemium", stem:"praemi", meaning:"reward" }, { nom:"signum", stem:"sign", meaning:"signal" },
      { nom:"verbum", stem:"verb", meaning:"word" }, { nom:"donum", stem:"don", meaning:"gift" },
    ],
    endings: { "nom.sg":"um","acc.sg":"um","gen.sg":"Ä«","dat.sg":"Å","abl.sg":"Å","nom.pl":"a","acc.pl":"a","gen.pl":"Årum","dat.pl":"Ä«s","abl.pl":"Ä«s" }
  },
  third: {
    label: "3rd Declension", nouns: [
      { nom:"miles", stem:"milit", meaning:"soldier" }, { nom:"rex", stem:"reg", meaning:"king" },
      { nom:"frater", stem:"fratr", meaning:"brother" }, { nom:"mors", stem:"mort", meaning:"death" },
      { nom:"dux", stem:"duc", meaning:"leader" }, { nom:"hostis", stem:"host", meaning:"enemy" },
      { nom:"virtus", stem:"virtut", meaning:"courage" }, { nom:"vulnus", stem:"vulner", meaning:"wound" },
      { nom:"soror", stem:"sorÅr", meaning:"sister" }, { nom:"sanguis", stem:"sanguin", meaning:"blood" },
    ],
    endings: { "nom.sg":"(varies)","acc.sg":"em","gen.sg":"is","dat.sg":"Ä«","abl.sg":"e","nom.pl":"Ä“s","acc.pl":"Ä“s","gen.pl":"um","dat.pl":"ibus","abl.pl":"ibus" }
  }
};
const CASE_NAMES = ["nominative","accusative","genitive","dative","ablative"];
const CASE_JOBS = {
  nominative:"subject â€” who does the action",
  accusative:"object â€” who receives the action",
  genitive:"possession â€” 'of'",
  dative:"indirect object â€” 'to/for'",
  ablative:"by/with/from â€” instrument, manner, or agent"
};

function generateDeclensionQuestions(count) {
  const qs = []; const decKeys = Object.keys(DECLENSIONS);
  for (let i = 0; i < count; i++) {
    const dk = decKeys[Math.floor(Math.random()*decKeys.length)];
    const dec = DECLENSIONS[dk];
    const noun = dec.nouns[Math.floor(Math.random()*dec.nouns.length)];
    const caseIdx = Math.floor(Math.random()*5);
    const num = Math.random()>0.5?"sg":"pl";
    const caseName = CASE_NAMES[caseIdx];
    const endingKey = caseName.substring(0,3)+"."+num;
    const correctEnding = dec.endings[endingKey];
    let form;
    if (dk==="third" && caseName==="nominative" && num==="sg") form = noun.nom;
    else form = noun.stem + correctEnding;
    const options = [
      { text: caseName, correct: true },
      ...CASE_NAMES.filter(c=>c!==caseName).sort(()=>Math.random()-0.5).slice(0,3).map(c=>({text:c,correct:false}))
    ].sort(()=>Math.random()-0.5);
    qs.push({ type:"identify_case", form, noun:noun.nom, meaning:noun.meaning, number:num==="sg"?"singular":"plural",
      declension:dec.label, correctCase:caseName, correctJob:CASE_JOBS[caseName], options });
  }
  return qs;
}

// ============================================================
// VERB DATA
// ============================================================
const VERBS = [
  { inf:"pugnare",conj:1,stem:"pugn",perfStem:"pugnav",meaning:"fight" },
  { inf:"necare",conj:1,stem:"nec",perfStem:"necav",meaning:"kill" },
  { inf:"vocare",conj:1,stem:"voc",perfStem:"vocav",meaning:"call" },
  { inf:"parare",conj:1,stem:"par",perfStem:"parav",meaning:"prepare" },
  { inf:"laudare",conj:1,stem:"laud",perfStem:"laudav",meaning:"praise" },
  { inf:"videre",conj:2,stem:"vid",perfStem:"vid",meaning:"see" },
  { inf:"habere",conj:2,stem:"hab",perfStem:"habu",meaning:"have" },
  { inf:"timere",conj:2,stem:"tim",perfStem:"timu",meaning:"fear" },
  { inf:"manere",conj:2,stem:"man",perfStem:"mans",meaning:"remain" },
  { inf:"ducere",conj:3,stem:"duc",perfStem:"dux",meaning:"lead" },
  { inf:"currere",conj:3,stem:"curr",perfStem:"cucurr",meaning:"run" },
  { inf:"vincere",conj:3,stem:"vinc",perfStem:"vic",meaning:"conquer" },
  { inf:"mittere",conj:3,stem:"mitt",perfStem:"mis",meaning:"send" },
  { inf:"interficere",conj:3,stem:"interfic",perfStem:"interfec",meaning:"kill" },
  { inf:"audire",conj:4,stem:"aud",perfStem:"audiv",meaning:"hear" },
  { inf:"venire",conj:4,stem:"ven",perfStem:"ven",meaning:"come" },
];
const PERSONS = [
  {label:"1st sg (I)",idx:0},{label:"2nd sg (you)",idx:1},{label:"3rd sg (he/she/it)",idx:2},
  {label:"1st pl (we)",idx:3},{label:"2nd pl (you pl)",idx:4},{label:"3rd pl (they)",idx:5},
];
const TENSES = ["present","imperfect","perfect","future","pluperfect"];

function conjugate(verb, tense, pIdx) {
  const {conj,stem,perfStem} = verb;
  const pe1=["Å","Äs","at","Ämus","Ätis","ant"], pe2=["eÅ","Ä“s","et","Ä“mus","Ä“tis","ent"],
    pe3=["Å","is","it","imus","itis","unt"], pe4=["iÅ","Ä«s","it","Ä«mus","Ä«tis","iunt"];
  const ie1=["Äbam","ÄbÄs","Äbat","ÄbÄmus","ÄbÄtis","Äbant"], ie2=["Ä“bam","Ä“bÄs","Ä“bat","Ä“bÄmus","Ä“bÄtis","Ä“bant"],
    ie3=["Ä“bam","Ä“bÄs","Ä“bat","Ä“bÄmus","Ä“bÄtis","Ä“bant"], ie4=["iÄ“bam","iÄ“bÄs","iÄ“bat","iÄ“bÄmus","iÄ“bÄtis","iÄ“bant"];
  const pfe=["Ä«","istÄ«","it","imus","istis","Ä“runt"];
  const fe1=["ÄbÅ","Äbis","Äbit","Äbimus","Äbitis","Äbunt"], fe2=["Ä“bÅ","Ä“bis","Ä“bit","Ä“bimus","Ä“bitis","Ä“bunt"],
    fe3=["am","Ä“s","et","Ä“mus","Ä“tis","ent"], fe4=["iam","iÄ“s","iet","iÄ“mus","iÄ“tis","ient"];
  const ple=["eram","erÄs","erat","erÄmus","erÄtis","erant"];
  switch(tense) {
    case "present": return stem+(conj===1?pe1:conj===2?pe2:conj===3?pe3:pe4)[pIdx];
    case "imperfect": return stem+(conj===1?ie1:conj===2?ie2:conj===3?ie3:ie4)[pIdx];
    case "perfect": return perfStem+pfe[pIdx];
    case "future": return stem+(conj===1?fe1:conj===2?fe2:conj===3?fe3:fe4)[pIdx];
    case "pluperfect": return perfStem+ple[pIdx];
    default: return stem;
  }
}

function generateVerbQuestions(count, allowedTenses) {
  const qs = [];
  for (let i=0;i<count;i++) {
    const verb = VERBS[Math.floor(Math.random()*VERBS.length)];
    const tense = allowedTenses[Math.floor(Math.random()*allowedTenses.length)];
    const person = PERSONS[Math.floor(Math.random()*PERSONS.length)];
    const correctForm = conjugate(verb,tense,person.idx);
    if (Math.random()>0.5) {
      const options = allowedTenses.map(t=>({text:t,correct:t===tense})).sort(()=>Math.random()-0.5);
      qs.push({ mode:"identify_tense", prompt:'What tense is "'+correctForm+'"?',
        subPrompt:verb.inf+" ("+verb.meaning+") â€” "+person.label, correctAnswer:tense, options,
        explanation:correctForm+" is the "+tense+" tense, "+person.label+" of "+verb.inf+" (to "+verb.meaning+")." });
    } else {
      const wrongForms = [];
      const otherTenses = allowedTenses.filter(t=>t!==tense);
      for (let j=0;j<3&&j<otherTenses.length;j++) wrongForms.push(conjugate(verb,otherTenses[j],person.idx));
      while(wrongForms.length<3) {
        const op=PERSONS[Math.floor(Math.random()*PERSONS.length)];
        const f=conjugate(verb,tense,op.idx);
        if(f!==correctForm&&!wrongForms.includes(f)) wrongForms.push(f);
      }
      const options = [{text:correctForm,correct:true},...wrongForms.slice(0,3).map(f=>({text:f,correct:false}))].sort(()=>Math.random()-0.5);
      qs.push({ mode:"pick_form", prompt:"Give the "+tense+" tense, "+person.label+" of:",
        subPrompt:verb.inf+" (to "+verb.meaning+")", correctAnswer:correctForm, options,
        explanation:"The "+tense+", "+person.label+" of "+verb.inf+' is "'+correctForm+'".' });
    }
  }
  return qs;
}

// ============================================================
// STORY QUEST DATA
// ============================================================
const STORY_CHAPTERS = [
  { title:"The Agreement",
    latin:"RÅma et Alba Longa diÅ« pugnÄverant. tandem rÄ“gÄ“s cÅnsilium cÄ“pÄ“runt. 'trÄ“s frÄtrÄ“s contrÄ trÄ“s frÄtrÄ“s pugnÄbunt,' inquit rÄ“x RÅmÄnus. 'sÄ«c bellum fÄ«nÄ«re placet.'",
    translation:"Rome and Alba Longa had fought for a long time. At last the kings formed a plan. 'Three brothers will fight against three brothers,' said the Roman king. 'It pleases us to end the war this way.'",
    questions: [
      { q:"How long had Rome and Alba Longa been fighting?", options:[{text:"For a long time (diÅ«)",correct:true},{text:"For three days",correct:false},{text:"They had not yet fought",correct:false},{text:"For one year",correct:false}],
        explanation:"diÅ« = for a long time. pugnÄverant is pluperfect â€” they HAD fought." },
      { q:"What tense is 'pugnÄverant'?", options:[{text:"Pluperfect â€” they HAD fought",correct:true},{text:"Perfect â€” they fought",correct:false},{text:"Imperfect â€” they were fighting",correct:false},{text:"Future â€” they will fight",correct:false}],
        explanation:"The -verant ending is the pluperfect marker: perfect stem + eram/erÄs/erat..." },
      { q:"What case is 'frÄtrÄ“s' in 'trÄ“s frÄtrÄ“s pugnÄbunt'?", options:[{text:"Nominative â€” they are the subject",correct:true},{text:"Accusative â€” they are the object",correct:false},{text:"Ablative â€” by the brothers",correct:false},{text:"Genitive â€” of the brothers",correct:false}],
        explanation:"frÄtrÄ“s is nominative plural (3rd decl.) â€” the brothers are DOING the fighting." },
      { q:"What tense is 'pugnÄbunt'?", options:[{text:"Future â€” they WILL fight",correct:true},{text:"Present â€” they fight",correct:false},{text:"Perfect â€” they fought",correct:false},{text:"Imperfect â€” they were fighting",correct:false}],
        explanation:"1st conjugation future: stem + -bÅ/-bis/-bit/-bimus/-bitis/-bunt." },
    ]
  },
  { title:"The Brothers Prepare",
    latin:"HorÄtiÄ«, trÄ“s frÄtrÄ“s RÅmÄnÄ«, arma cÄ“pÄ“runt. CÅ«riÄtiÄ«, trÄ“s frÄtrÄ“s AlbÄnÄ«, quoque sÄ“ parÄvÄ“runt. utrique fortÄ“s erant. populus timÄ“bat â€” nam frÄtrÄ“s ad mortem Ä«bant.",
    translation:"The Horatii, three Roman brothers, took up arms. The Curiatii, three Alban brothers, also prepared themselves. Both sides were brave. The people feared â€” for the brothers were going to their death.",
    questions: [
      { q:"What case is 'arma' in 'arma cÄ“pÄ“runt'?", options:[{text:"Accusative â€” it is the object of 'took'",correct:true},{text:"Nominative â€” it is the subject",correct:false},{text:"Ablative â€” by/with arms",correct:false},{text:"Genitive â€” of the arms",correct:false}],
        explanation:"arma is accusative plural (2nd decl. neuter) â€” the THING they took." },
      { q:"What does 'utrique fortÄ“s erant' mean?", options:[{text:"Both sides were brave",correct:true},{text:"All the brothers were fortunate",correct:false},{text:"The Romans were braver",correct:false},{text:"Neither side was strong",correct:false}],
        explanation:"utrique = both (sides). fortÄ“s = brave. erant = imperfect of sum = were." },
      { q:"Why did the populus (people) fear?", options:[{text:"Because the brothers were going to their death",correct:true},{text:"Because the enemy was approaching",correct:false},{text:"Because the king was angry",correct:false},{text:"Because the city walls had fallen",correct:false}],
        explanation:"nam frÄtrÄ“s ad mortem Ä«bant â€” for the brothers were going to (their) death." },
      { q:"What tense is 'timÄ“bat'?", options:[{text:"Imperfect â€” was fearing / feared (ongoing)",correct:true},{text:"Perfect â€” feared (completed)",correct:false},{text:"Pluperfect â€” had feared",correct:false},{text:"Present â€” fears",correct:false}],
        explanation:"The -bat ending marks imperfect tense: ongoing or repeated past action." },
    ]
  },
  { title:"The Battle",
    latin:"pugnÄtum est Äcriter. duo HorÄtiÄ« cecidÄ“runt. trÄ“s CÅ«riÄtiÄ« vulnerÄtÄ« erant sed vÄ«vÄ“bant. Å«nus HorÄtius sÅlus stÄbat. spectÄtÅrÄ“s clÄmÄvÄ“runt: 'RÅma perit!'",
    translation:"They fought fiercely. Two of the Horatii fell. Three Curiatii were wounded but alive. One Horatius stood alone. The spectators cried out: 'Rome is lost!'",
    questions: [
      { q:"What happened to two of the Horatii?", options:[{text:"They fell (were killed)",correct:true},{text:"They fled from the battle",correct:false},{text:"They were wounded but survived",correct:false},{text:"They surrendered",correct:false}],
        explanation:"cecidÄ“runt = perfect of cadÅ (to fall). In military context: they were killed." },
      { q:"What tense is 'vulnerÄtÄ« erant'?", options:[{text:"Pluperfect passive â€” they had been wounded",correct:true},{text:"Imperfect â€” they were being wounded",correct:false},{text:"Perfect â€” they were wounded",correct:false},{text:"Present â€” they are wounded",correct:false}],
        explanation:"Perfect participle + erant (imperfect of sum) = pluperfect passive." },
      { q:"What case is 'spectÄtÅrÄ“s' in this passage?", options:[{text:"Nominative â€” they are the subject (they cried out)",correct:true},{text:"Accusative â€” they are the object",correct:false},{text:"Genitive â€” of the spectators",correct:false},{text:"Ablative â€” by the spectators",correct:false}],
        explanation:"spectÄtÅrÄ“s clÄmÄvÄ“runt â€” the spectators (nom.) cried out." },
    ]
  },
  { title:"The Cunning Flight",
    latin:"sed HorÄtius callidus erat. fÅ«git â€” nÅn quod timÄ“bat, sed quod cÅnsilium habÄ“bat. CÅ«riÄtiÄ« eum secÅ«tÄ« sunt, sed nÅn eÅdem tempore â€” nam vulnera eÅs tardÄverant. prÄ«mus CÅ«riÄtius advÄ“nit. HorÄtius sÄ“ vertit et eum interfÄ“cit.",
    translation:"But Horatius was cunning. He fled â€” not because he feared, but because he had a plan. The Curiatii followed him, but not at the same time â€” for their wounds had slowed them. The first Curiatian arrived. Horatius turned and killed him.",
    questions: [
      { q:"Why did Horatius run away?", options:[{text:"He had a plan to separate the wounded Curiatii",correct:true},{text:"He was a coward",correct:false},{text:"He wanted to reach the city walls",correct:false},{text:"The king ordered him to retreat",correct:false}],
        explanation:"nÅn quod timÄ“bat, sed quod cÅnsilium habÄ“bat â€” not because he feared, but because he had a plan." },
      { q:"What tense is 'tardÄverant' (had slowed)?", options:[{text:"Pluperfect â€” the wounds HAD slowed them",correct:true},{text:"Perfect â€” the wounds slowed them",correct:false},{text:"Imperfect â€” the wounds were slowing them",correct:false},{text:"Future â€” the wounds will slow them",correct:false}],
        explanation:"tardÄverant: perfect stem tardÄv- + -erant = pluperfect. The slowing happened BEFORE the chase." },
      { q:"What case is 'eum' in 'eum interfÄ“cit'?", options:[{text:"Accusative â€” him (direct object of killed)",correct:true},{text:"Nominative â€” he",correct:false},{text:"Dative â€” to/for him",correct:false},{text:"Ablative â€” by him",correct:false}],
        explanation:"eum = him (accusative of is). He killed HIM â€” the object of interfÄ“cit." },
      { q:"What does 'sÄ“ vertit' mean?", options:[{text:"He turned (himself)",correct:true},{text:"He saw himself",correct:false},{text:"He defended himself",correct:false},{text:"He hid himself",correct:false}],
        explanation:"sÄ“ vertit: vertÅ = I turn. sÄ“ = himself (reflexive). He turned himself around to face his pursuer." },
    ]
  },
  { title:"Victory and Triumph",
    latin:"deinde secundum et tertium CÅ«riÄtium interfÄ“cit. victor HorÄtius ad urbem rediit. spolia hostium ferÄ“bat. RÅmÄnÄ« eum laudÄvÄ“runt: RÅma victrix erat!",
    translation:"Then he killed the second and third Curiatian. Victorious, Horatius returned to the city. He was carrying the spoils of the enemies. The Romans praised him: Rome was victorious!",
    questions: [
      { q:"What tense is 'rediit'?", options:[{text:"Perfect â€” he returned",correct:true},{text:"Present â€” he returns",correct:false},{text:"Imperfect â€” he was returning",correct:false},{text:"Pluperfect â€” he had returned",correct:false}],
        explanation:"rediit = perfect of redeÅ (re + eÅ). He returned â€” completed action." },
      { q:"What case is 'hostium' in 'spolia hostium'?", options:[{text:"Genitive â€” 'of the enemies' (possession)",correct:true},{text:"Accusative â€” the enemies",correct:false},{text:"Dative â€” to/for the enemies",correct:false},{text:"Ablative â€” by the enemies",correct:false}],
        explanation:"hostium = genitive plural of hostis (3rd decl.). The spoils OF THE ENEMIES." },
      { q:"What tense is 'ferÄ“bat'?", options:[{text:"Imperfect â€” he was carrying (ongoing)",correct:true},{text:"Perfect â€” he carried",correct:false},{text:"Present â€” he carries",correct:false},{text:"Future â€” he will carry",correct:false}],
        explanation:"ferÄ“bat: imperfect of ferÅ. The -bat ending = imperfect. He WAS carrying." },
      { q:"What is Horatius carrying?", options:[{text:"The spoils (armour/weapons) of the enemies",correct:true},{text:"A message for the king",correct:false},{text:"His wounded brothers",correct:false},{text:"A Roman standard",correct:false}],
        explanation:"spolia hostium = the spoils of the enemies. In Roman custom, taking an enemy's armour was the ultimate trophy." },
    ]
  },
  { title:"The Sister's Grief",
    latin:"sed soror HorÄtiÄ« ad portam stÄbat. sponsa Å«nÄ«us CÅ«riÄtiÄ« fuerat. ubi pallium sponsÄ« in umerÄ«s frÄtris vÄ«dit, lacrimÄvit et nÅmen mortuum vocÄvit. HorÄtius, Ä«rÄ incÄ“nsus, sorÅrem gladiÅ trÄnsfÄ«xit.",
    translation:"But the sister of Horatius was standing at the gate. She had been the fiancÃ©e of one of the Curiatii. When she saw her fiancÃ©'s cloak on her brother's shoulders, she wept and called out the dead man's name. Horatius, inflamed with anger, stabbed his sister with his sword.",
    questions: [
      { q:"What tense is 'fuerat' (she had been)?", options:[{text:"Pluperfect â€” she HAD been his fiancÃ©e",correct:true},{text:"Perfect â€” she was",correct:false},{text:"Imperfect â€” she was being",correct:false},{text:"Future â€” she will be",correct:false}],
        explanation:"fuerat = pluperfect of sum. fu- (perfect stem) + -erat = she had been." },
      { q:"What case is 'gladiÅ' in 'gladiÅ trÄnsfÄ«xit'?", options:[{text:"Ablative â€” 'with a sword' (instrument)",correct:true},{text:"Dative â€” 'to/for the sword'",correct:false},{text:"Accusative â€” 'the sword'",correct:false},{text:"Nominative â€” 'the sword' (subject)",correct:false}],
        explanation:"gladiÅ = ablative singular of gladius (2nd decl.). The ablative of instrument: WITH a sword." },
      { q:"What case is 'sorÅrem'?", options:[{text:"Accusative â€” she is the object (he stabbed HER)",correct:true},{text:"Nominative â€” she is the subject",correct:false},{text:"Genitive â€” of the sister",correct:false},{text:"Dative â€” to the sister",correct:false}],
        explanation:"sorÅrem = accusative singular of soror (3rd decl.). Direct object of trÄnsfÄ«xit." },
      { q:"'sÄ«c eat quaecumque RÅmÄna lÅ«gÄ“bit hostem' â€” what does this famous line mean?", options:[{text:"'So perish any Roman woman who mourns an enemy'",correct:true},{text:"'Thus Rome defeats all her enemies'",correct:false},{text:"'Every Roman must fight bravely'",correct:false},{text:"'The enemy will always be destroyed'",correct:false}],
        explanation:"Horatius's chilling justification. He equates mourning an enemy with treason against Rome." },
    ]
  },
  { title:"The Trial",
    latin:"HorÄtius accÅ«sÄtus est. cÄ«vÄ“s rogÄvÄ“runt: 'estne hÄ“rÅs an homicÄ«da?' pater HorÄtiÄ« prÅ fÄ«liÅ dÄ«xit: 'fÄ«liam meam iÅ«re caesam iÅ«dicÅ. sÄ« nÅn, patria potestÄte fÄ«lium animadvertissem.' populus eum absolvit â€” sed sub tigillÅ trÄnsÄ«re dÄ“buit.",
    translation:"Horatius was accused. The citizens asked: 'Is he a hero or a murderer?' The father of Horatius spoke for his son: 'I judge my daughter justly killed. If not, I would have punished my son by my paternal power.' The people acquitted him â€” but he had to pass under a beam.",
    questions: [
      { q:"What question did the citizens ask?", options:[{text:"Is Horatius a hero or a murderer?",correct:true},{text:"Should Rome or Alba Longa rule?",correct:false},{text:"Should the father be punished too?",correct:false},{text:"Should the war continue?",correct:false}],
        explanation:"estne hÄ“rÅs an homicÄ«da? The central moral question of the whole story." },
      { q:"How did the father defend his son?", options:[{text:"He said his daughter was justly killed, and he'd have punished Horatius himself otherwise",correct:true},{text:"He said Horatius was insane",correct:false},{text:"He blamed the Curiatii",correct:false},{text:"He said the gods commanded it",correct:false}],
        explanation:"The father uses patria potestas â€” his legal right over the family â€” to argue the killing was within family authority." },
      { q:"What does 'patria potestÄte' refer to?", options:[{text:"The father's legal power over his family â€” including life and death",correct:true},{text:"The power of the state over citizens",correct:false},{text:"Military authority of a general",correct:false},{text:"Religious power of a priest",correct:false}],
        explanation:"Patria potestas = the father's power. A Roman paterfamilias legally held power of life and death over ALL members of his household." },
      { q:"What ritual did Horatius undergo after acquittal?", options:[{text:"Pass under a beam (tigillum sorÅrium) as purification",correct:true},{text:"Sacrifice a bull at the temple of Mars",correct:false},{text:"Go into exile for one year",correct:false},{text:"Pay a fine to the Curiatii family",correct:false}],
        explanation:"Even after acquittal, Horatius needed ritual purification â€” the tigillum sorÅrium. Even Rome found this morally troubling." },
    ]
  },
];

// ============================================================
// BOSS ROUND DATA
// ============================================================
const BOSS_POOL = [
  { prompt:"In 'frÄtrÄ“s ad mortem Ä«bant' â€” what case is 'mortem'?", options:[{text:"Accusative â€” direction/motion towards",correct:true},{text:"Ablative â€” from death",correct:false},{text:"Nominative â€” death as subject",correct:false},{text:"Genitive â€” of death",correct:false}], explanation:"After 'ad' (to/towards), we always use the accusative case." },
  { prompt:"Translate: 'HorÄtius gladium cÄ“pit'", options:[{text:"Horatius took his sword",correct:true},{text:"Horatius gave his sword",correct:false},{text:"Horatius threw his sword",correct:false},{text:"The sword took Horatius",correct:false}], explanation:"cÄ“pit (perfect of capiÅ) = he took. gladium is accusative = the object." },
  { prompt:"What tense: 'pugnÄverant' (they had fought)?", options:[{text:"Pluperfect",correct:true},{text:"Perfect",correct:false},{text:"Future perfect",correct:false},{text:"Imperfect",correct:false}], explanation:"The -verant ending signals pluperfect: perfect stem + eram/erÄs/erat..." },
  { prompt:"'vulnera militum gravia erant' â€” what case is 'militum'?", options:[{text:"Genitive plural â€” 'of the soldiers'",correct:true},{text:"Accusative plural",correct:false},{text:"Dative plural",correct:false},{text:"Ablative plural",correct:false}], explanation:"militum is genitive plural of miles (3rd decl.) â€” wounds OF THE SOLDIERS." },
  { prompt:"Which is the future tense of 'vincere' (3rd conj., 1st sg)?", options:[{text:"vincam",correct:true},{text:"vincÅ",correct:false},{text:"vincÄ“bam",correct:false},{text:"vÄ«cÄ«",correct:false}], explanation:"3rd conjugation future uses -am, -Ä“s, -et pattern (NOT -bÅ like 1st/2nd)." },
  { prompt:"Why is the 3rd/4th conjugation future easily confused with the present subjunctive?", options:[{text:"Both use -a- in the 1st person singular",correct:true},{text:"They have identical endings in all persons",correct:false},{text:"They use the same stem",correct:false},{text:"They are not easily confused",correct:false}], explanation:"vincam (fut.) looks like a subjunctive. Context and the other forms (-Ä“s, -et) confirm it's future." },
  { prompt:"'rÄ“x populÅ placuit' â€” what case is 'populÅ'?", options:[{text:"Dative â€” 'was pleasing TO the people'",correct:true},{text:"Ablative â€” 'by the people'",correct:false},{text:"Nominative",correct:false},{text:"Accusative",correct:false}], explanation:"placet/placuit takes the DATIVE for the person pleased." },
  { prompt:"What Roman legal concept allows the father to claim authority over his daughter's death?", options:[{text:"Patria potestas â€” the father's absolute legal power over his family",correct:true},{text:"The right of a citizen to appeal",correct:false},{text:"The power of a magistrate to overrule the senate",correct:false},{text:"The right of a soldier to keep spoils",correct:false}], explanation:"Patria potestas = the father's power. Life and death over all household members." },
  { prompt:"Which is the pluperfect of 'audiÅ' (4th conj., 3rd pl)?", options:[{text:"audÄ«verant",correct:true},{text:"audiÄ“bant",correct:false},{text:"audÄ«vÄ“runt",correct:false},{text:"audient",correct:false}], explanation:"Pluperfect = perfect stem + eram etc. audÄ«v + erant = audÄ«verant (they had heard)." },
  { prompt:"'soror frÄtris' â€” what case is 'frÄtris'?", options:[{text:"Genitive singular â€” 'of the brother' (3rd decl.)",correct:true},{text:"Nominative",correct:false},{text:"Dative",correct:false},{text:"Accusative",correct:false}], explanation:"frÄtris = genitive singular of frÄter (3rd decl.)." },
  { prompt:"Translate: 'trÄ“s frÄtrÄ“s pugnÄbunt'", options:[{text:"Three brothers will fight",correct:true},{text:"Three brothers fought",correct:false},{text:"Three brothers were fighting",correct:false},{text:"Three brothers had fought",correct:false}], explanation:"pugnÄbunt: 1st conj. future (-bunt = 3rd pl). They WILL fight." },
  { prompt:"Was Horatius right to kill his sister? The Romans thought...", options:[{text:"He was acquitted but required ritual purification â€” morally complex",correct:true},{text:"He was celebrated without consequences",correct:false},{text:"He was executed for murder",correct:false},{text:"He was exiled permanently",correct:false}], explanation:"Acquitted but purified under the tigillum sorÅrium â€” even Rome found it troubling." },
  { prompt:"What is the future tense of 'audiÅ' (4th conj., 3rd sg)?", options:[{text:"audiet",correct:true},{text:"audit",correct:false},{text:"audiÄ“bat",correct:false},{text:"audÄ«vit",correct:false}], explanation:"4th conj. future: stem + iam/iÄ“s/iet/iÄ“mus/iÄ“tis/ient." },
  { prompt:"In 'CÅ«riÄtiÄ« eum secÅ«tÄ« sunt' â€” what voice is 'secÅ«tÄ« sunt'?", options:[{text:"Deponent â€” passive form but active meaning (they followed)",correct:true},{text:"Passive â€” they were followed",correct:false},{text:"Active â€” they followed",correct:false},{text:"Middle voice",correct:false}], explanation:"sequor is deponent: passive in form, active in meaning. secÅ«tÄ« sunt = they followed." },
  { prompt:"What case follows 'contrÄ'?", options:[{text:"Accusative",correct:true},{text:"Ablative",correct:false},{text:"Genitive",correct:false},{text:"Dative",correct:false}], explanation:"contrÄ + accusative. Always. 'against' takes the accusative case." },
  { prompt:"'necesse est pugnÄre' means...", options:[{text:"It is necessary to fight",correct:true},{text:"He does not want to fight",correct:false},{text:"Fighting is not allowed",correct:false},{text:"The fight has ended",correct:false}], explanation:"necesse est + infinitive = it is necessary to... A key construction in Unit 18." },
];

function generateBossQuestions(count) {
  return [...BOSS_POOL].sort(()=>Math.random()-0.5).slice(0,count);
}

// ============================================================
// SHARED COMPONENTS
// ============================================================
const Card = ({children, style={}, glow=false, className=""}) => (
  <div className={className} style={{
    background:T.surface, border:"1px solid "+(glow?T.gold:T.border), borderRadius:"8px",
    padding:"20px", marginBottom:"16px",
    boxShadow: glow?"0 0 20px "+T.goldDim+"40":"0 2px 8px #00000040", ...style
  }}>{children}</div>
);

const Btn = ({children, onClick, variant="default", disabled=false, style={}}) => {
  const base = { padding:"10px 20px", border:"none", borderRadius:"6px", fontFamily:SANS,
    fontSize:"14px", cursor:disabled?"not-allowed":"pointer", opacity:disabled?0.5:1,
    transition:"all 0.2s", fontWeight:"600", ...style };
  const v = {
    default:{background:T.surfaceLight,color:T.text,border:"1px solid "+T.border},
    gold:{background:"linear-gradient(135deg,"+T.gold+","+T.bronze+")",color:"#1a1611"},
    crimson:{background:T.crimson,color:T.text},
    green:{background:T.green,color:T.text},
    ghost:{background:"transparent",color:T.textDim,border:"1px solid "+T.border},
  };
  return <button onClick={disabled?undefined:onClick} style={{...base,...v[variant]}} disabled={disabled}>{children}</button>;
};

const XPBadge = ({xp}) => (
  <span style={{ display:"inline-flex",alignItems:"center",gap:"4px",
    background:T.gold+"20",border:"1px solid "+T.goldDim,borderRadius:"20px",padding:"4px 12px",
    fontFamily:SANS,fontSize:"13px",color:T.gold,fontWeight:"700" }}>âš¡ {xp} XP</span>
);

const ProgressBar = ({current,total,color=T.gold}) => (
  <div style={{background:T.surfaceLight,borderRadius:"10px",height:"8px",overflow:"hidden",margin:"8px 0"}}>
    <div style={{ width:Math.min((current/total)*100,100)+"%", height:"100%",
      background:"linear-gradient(90deg,"+color+","+color+"cc)", borderRadius:"10px", transition:"width 0.5s ease" }}/>
  </div>
);

// ============================================================
// LOGIN SCREEN
// ============================================================
const LoginScreen = ({onLogin}) => {
  const [name,setName] = useState("");
  const [classGroup,setClassGroup] = useState("");

  useEffect(()=>{ const u=loadUser(); if(u) onLogin(u); },[]);

  const handleLogin = () => {
    if(!name.trim()||!classGroup.trim()) return;
    const user = {name:name.trim(),classGroup:classGroup.trim(),xp:0,sessions:0};
    saveUser(user); updateLeaderboard(user.name,user.classGroup,0); onLogin(user);
  };

  return (
    <div style={{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"100vh",background:T.bg,padding:"20px"}}>
      <div style={{maxWidth:"420px",width:"100%",textAlign:"center"}}>
        <p style={{fontFamily:SERIF,fontSize:"11px",color:T.textMuted,letterSpacing:"4px",textTransform:"uppercase",marginBottom:"8px"}}>Unit 18 Â· The Horatii and Curiatii</p>
        <h1 style={{fontFamily:SERIF,fontSize:"40px",color:T.gold,margin:"0 0 4px 0",fontWeight:"400",letterSpacing:"2px"}}>ARENA LATINA</h1>
        <div style={{width:"60px",height:"2px",background:"linear-gradient(90deg,transparent,"+T.gold+",transparent)",margin:"12px auto 20px"}}/>
        <p style={{fontFamily:SERIF,fontSize:"15px",color:T.textDim,fontStyle:"italic",marginBottom:"32px"}}>Master the grammar. Know the story. Claim the glory.</p>
        <Card>
          <p style={{fontFamily:SANS,fontSize:"13px",color:T.textDim,marginBottom:"16px"}}>Enter your details to begin</p>
          <input type="text" placeholder="Your name" value={name} onChange={e=>setName(e.target.value)}
            style={{width:"100%",padding:"12px 16px",background:T.surfaceLight,border:"1px solid "+T.border,borderRadius:"6px",color:T.text,fontFamily:SANS,fontSize:"15px",marginBottom:"12px"}}/>
          <input type="text" placeholder="Class (e.g. 10A)" value={classGroup} onChange={e=>setClassGroup(e.target.value)} onKeyDown={e=>e.key==="Enter"&&handleLogin()}
            style={{width:"100%",padding:"12px 16px",background:T.surfaceLight,border:"1px solid "+T.border,borderRadius:"6px",color:T.text,fontFamily:SANS,fontSize:"15px",marginBottom:"20px"}}/>
          <Btn variant="gold" onClick={handleLogin} disabled={!name.trim()||!classGroup.trim()} style={{width:"100%",padding:"14px",fontSize:"16px"}}>Enter the Arena âš”</Btn>
        </Card>
        <Card style={{background:T.crimsonDark+"40",border:"1px solid "+T.crimson+"40"}}>
          <p style={{fontFamily:SANS,fontSize:"13px",color:T.crimsonLight,fontWeight:"600",marginBottom:"4px"}}>ğŸ† Top 5 = 5% exam bonus</p>
          <p style={{fontFamily:SANS,fontSize:"12px",color:T.textMuted}}>The leaderboard tracks your XP across all sessions. The top 5 players earn a 5% upgrade on their end-of-unit exam.</p>
        </Card>
      </div>
    </div>
  );
};

// ============================================================
// QUIZ ENGINE
// ============================================================
const QuizEngine = ({questions,title,icon,onComplete,xpPerCorrect=10,streakBonus=5,perfectBonus=50}) => {
  const [idx,setIdx]=useState(0);
  const [score,setScore]=useState(0);
  const [streak,setStreak]=useState(0);
  const [selected,setSelected]=useState(null);
  const [showResult,setShowResult]=useState(false);
  const [xpEarned,setXpEarned]=useState(0);
  const [done,setDone]=useState(false);
  const q = questions[idx];

  const handleSelect = (i) => {
    if(showResult) return;
    setSelected(i); setShowResult(true);
    if(q.options[i].correct) {
      const bonus=Math.min(streak*streakBonus,25);
      setScore(s=>s+1); setStreak(s=>s+1); setXpEarned(x=>x+xpPerCorrect+bonus);
    } else setStreak(0);
  };

  const handleNext = () => {
    if(idx+1>=questions.length) {
      const finalXP = xpEarned + (score===questions.length?perfectBonus:0);
      setDone(true); onComplete(finalXP,score,questions.length);
    } else { setIdx(i=>i+1); setSelected(null); setShowResult(false); }
  };

  if(done) return null;

  return (
    <div className="fade-in">
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"12px"}}>
        <span style={{fontFamily:SANS,fontSize:"13px",color:T.textDim}}>{icon} {title}</span>
        <div style={{display:"flex",gap:"12px",alignItems:"center"}}>
          {streak>=2 && <span className="streak-anim" style={{fontFamily:SANS,fontSize:"12px",color:T.goldBright}}>ğŸ”¥ {streak} streak</span>}
          <XPBadge xp={xpEarned}/>
        </div>
      </div>
      <ProgressBar current={idx+1} total={questions.length}/>
      <p style={{fontFamily:SANS,fontSize:"12px",color:T.textMuted,marginBottom:"16px"}}>Question {idx+1} of {questions.length}</p>
      <Card glow>
        <p style={{fontFamily:SERIF,fontSize:"18px",color:T.text,marginBottom:"8px",lineHeight:"1.5"}}>
          {q.prompt || q.q || 'What case is "'+q.form+'"?'}
        </p>
        {q.subPrompt && <p style={{fontFamily:SANS,fontSize:"13px",color:T.textDim,marginBottom:"4px"}}>{q.subPrompt}</p>}
        {q.form && <p style={{fontFamily:SERIF,fontSize:"14px",color:T.textDim,marginBottom:"4px"}}>{q.noun} ({q.meaning}) â€” {q.declension} â€” {q.number}</p>}
      </Card>
      <div style={{display:"grid",gap:"8px",marginBottom:"16px"}}>
        {q.options.map((opt,i) => {
          let bg=T.surfaceLight, bc=T.border, tc=T.text;
          if(showResult) {
            if(opt.correct){bg=T.green+"30";bc=T.green;tc=T.greenLight;}
            else if(i===selected&&!opt.correct){bg=T.red+"30";bc=T.red;tc=T.red;}
          }
          return <button key={i} onClick={()=>handleSelect(i)} disabled={showResult}
            style={{padding:"14px 18px",background:bg,border:"1px solid "+bc,borderRadius:"8px",color:tc,
              fontFamily:SANS,fontSize:"14px",textAlign:"left",cursor:showResult?"default":"pointer",
              transition:"all 0.2s",lineHeight:"1.4"}}>{opt.text}</button>;
        })}
      </div>
      {showResult && <div className="fade-in">
        {(q.explanation||(q.correctCase&&q.correctJob)) &&
          <Card style={{background:T.blue+"15",border:"1px solid "+T.blue+"40"}}>
            <p style={{fontFamily:SANS,fontSize:"13px",color:T.textDim,lineHeight:"1.5"}}>
              ğŸ’¡ {q.explanation || (<span><strong style={{color:T.text}}>{q.correctCase}</strong> â€” {q.correctJob}</span>)}
            </p>
          </Card>
        }
        <Btn variant="gold" onClick={handleNext} style={{width:"100%"}}>
          {idx+1>=questions.length?"See Results â†’":"Next Question â†’"}
        </Btn>
      </div>}
    </div>
  );
};

// ============================================================
// COMPLETION SCREEN
// ============================================================
const CompletionScreen = ({xp,score,total,title,onBack}) => {
  const pct=Math.round((score/total)*100);
  const grade=pct===100?"PERFECT":pct>=80?"EXCELLENT":pct>=60?"GOOD":"KEEP PRACTISING";
  const gc=pct===100?T.goldBright:pct>=80?T.green:pct>=60?T.blue:T.textDim;
  const emoji=pct===100?"ğŸ†":pct>=80?"âš”":pct>=60?"ğŸ›¡":"ğŸ“š";
  return (
    <div style={{textAlign:"center",padding:"20px 0"}} className="fade-in">
      <p style={{fontFamily:SERIF,fontSize:"48px",margin:"0 0 8px 0"}}>{emoji}</p>
      <h2 style={{fontFamily:SERIF,fontSize:"28px",color:gc,margin:"0 0 4px 0"}}>{grade}</h2>
      <p style={{fontFamily:SANS,fontSize:"14px",color:T.textDim,marginBottom:"20px"}}>{title}</p>
      <Card glow={pct===100} className={pct===100?"pulse-gold":""}>
        <div style={{display:"flex",justifyContent:"center",gap:"32px",flexWrap:"wrap"}}>
          <div><p style={{fontFamily:SANS,fontSize:"32px",color:T.gold,fontWeight:"700",margin:0}}>{xp}</p><p style={{fontFamily:SANS,fontSize:"12px",color:T.textMuted}}>XP earned</p></div>
          <div><p style={{fontFamily:SANS,fontSize:"32px",color:T.text,fontWeight:"700",margin:0}}>{score}/{total}</p><p style={{fontFamily:SANS,fontSize:"12px",color:T.textMuted}}>correct</p></div>
          <div><p style={{fontFamily:SANS,fontSize:"32px",color:gc,fontWeight:"700",margin:0}}>{pct}%</p><p style={{fontFamily:SANS,fontSize:"12px",color:T.textMuted}}>accuracy</p></div>
        </div>
      </Card>
      {pct===100 && <p style={{fontFamily:SERIF,fontSize:"14px",color:T.gold,fontStyle:"italic",margin:"12px 0"}}>+50 bonus XP for a perfect round!</p>}
      <Btn variant="gold" onClick={onBack} style={{marginTop:"16px"}}>â† Back to Arena</Btn>
    </div>
  );
};

// ============================================================
// LEADERBOARD
// ============================================================
const Leaderboard = ({currentUser}) => {
  const lb = loadLeaderboard();
  const entries = Object.values(lb).sort((a,b)=>b.xp-a.xp);
  const top5 = entries.slice(0,5);
  const rest = entries.slice(5,15);
  const userRank = entries.findIndex(e=>e.name===currentUser.name)+1;
  const medals=["ğŸ¥‡","ğŸ¥ˆ","ğŸ¥‰","4th","5th"];

  return (
    <div className="fade-in">
      <div style={{textAlign:"center",marginBottom:"24px"}}>
        <p style={{fontFamily:SERIF,fontSize:"11px",color:T.textMuted,letterSpacing:"3px",textTransform:"uppercase",marginBottom:"4px"}}>ARENA LATINA</p>
        <h2 style={{fontFamily:SERIF,fontSize:"28px",color:T.gold,margin:"0 0 8px 0"}}>ğŸ† Leaderboard</h2>
        <Card style={{background:T.crimsonDark+"40",border:"1px solid "+T.crimson+"40",display:"inline-block"}}>
          <p style={{fontFamily:SANS,fontSize:"13px",color:T.crimsonLight}}>âš¡ Top 5 earn a <strong>5% bonus</strong> on the end-of-unit exam</p>
        </Card>
      </div>
      {top5.length===0 ? <Card><p style={{color:T.textDim,textAlign:"center",fontFamily:SANS}}>No entries yet â€” be the first!</p></Card> :
        top5.map((entry,i) => {
          const isU = entry.name===currentUser.name;
          return <Card key={i} glow={i===0} style={{display:"flex",justifyContent:"space-between",alignItems:"center",
            background:isU?T.gold+"10":i<3?T.gold+"08":T.surface,border:"1px solid "+(isU?T.gold:T.goldDim+"40")}}>
            <div style={{display:"flex",alignItems:"center",gap:"12px"}}>
              <span style={{fontFamily:SANS,fontSize:i<3?"24px":"14px",width:"36px",textAlign:"center",color:i<3?T.gold:T.textDim}}>{medals[i]}</span>
              <div><p style={{fontFamily:SANS,fontSize:"15px",color:isU?T.gold:T.text,fontWeight:"600",margin:0}}>{entry.name} {isU&&"(you)"}</p>
                <p style={{fontFamily:SANS,fontSize:"12px",color:T.textMuted,margin:0}}>{entry.classGroup}</p></div>
            </div>
            <XPBadge xp={entry.xp}/>
          </Card>;
        })
      }
      {rest.length>0 && <div style={{marginTop:"16px"}}>
        <p style={{fontFamily:SANS,fontSize:"12px",color:T.textMuted,marginBottom:"8px"}}>Others:</p>
        {rest.map((entry,i) => {
          const isU=entry.name===currentUser.name;
          return <div key={i} style={{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"8px 16px",borderBottom:"1px solid "+T.border+"20",background:isU?T.gold+"08":"transparent"}}>
            <span style={{fontFamily:SANS,fontSize:"13px",color:isU?T.gold:T.textDim}}>#{i+6} {entry.name} {isU&&"(you)"} <span style={{color:T.textMuted}}>Â· {entry.classGroup}</span></span>
            <span style={{fontFamily:SANS,fontSize:"12px",color:T.goldDim}}>âš¡ {entry.xp}</span>
          </div>;
        })}
      </div>}
      {userRank>0 && <Card style={{marginTop:"20px",textAlign:"center"}}>
        <p style={{fontFamily:SANS,fontSize:"13px",color:T.textDim}}>Your rank: <strong style={{color:userRank<=5?T.gold:T.text}}>#{userRank}</strong>
          {userRank<=5?" â€” You're in the top 5! ğŸ†":entries.length>0&&top5.length>=5?" â€” "+Math.max(0,top5[4].xp-currentUser.xp)+" XP to reach top 5":" â€” Keep going!"}
        </p>
      </Card>}
    </div>
  );
};

// ============================================================
// MAIN APP
// ============================================================
function App() {
  const [user,setUser]=useState(null);
  const [mode,setMode]=useState("home");
  const [subMode,setSubMode]=useState(null);
  const [gameQs,setGameQs]=useState(null);
  const [completion,setCompletion]=useState(null);

  const addXP = (amount) => {
    const nu = {...user,xp:user.xp+amount,sessions:user.sessions+1};
    setUser(nu); saveUser(nu); updateLeaderboard(nu.name,nu.classGroup,nu.xp);
  };

  const handleComplete = (xp,score,total) => {
    addXP(xp);
    const labels={declension:"Declension Arena",verbs:"Verb Forge",story:"Story Quest",boss:"Boss Round"};
    setCompletion({xp,score,total,title:labels[mode]||"Round"});
  };

  const goHome = ()=>{setMode("home");setSubMode(null);setGameQs(null);setCompletion(null);};

  const resetProfile = ()=>{
    if(confirm("This will reset your name and class (your XP stays on the leaderboard). Continue?")) {
      localStorage.removeItem("arena-latina-user"); setUser(null); setMode("home");
    }
  };

  if(!user) return <LoginScreen onLogin={setUser}/>;

  if(completion) return (
    <div style={{background:T.bg,minHeight:"100vh",padding:"20px"}}>
      <div style={{maxWidth:"560px",margin:"0 auto"}}><CompletionScreen {...completion} onBack={goHome}/></div>
    </div>
  );

  return (
    <div style={{background:T.bg,minHeight:"100vh",color:T.text}}>
      {/* Header */}
      <div style={{background:T.surface,borderBottom:"1px solid "+T.border,padding:"12px 20px",display:"flex",justifyContent:"space-between",alignItems:"center",flexWrap:"wrap",gap:"8px"}}>
        <div style={{display:"flex",alignItems:"center",gap:"16px"}}>
          <span onClick={goHome} style={{fontFamily:SERIF,fontSize:"18px",color:T.gold,cursor:"pointer",letterSpacing:"1px"}}>ARENA LATINA</span>
          {mode!=="home" && <button onClick={goHome} style={{background:"none",border:"none",color:T.textDim,fontFamily:SANS,fontSize:"13px",cursor:"pointer"}}>â† Back</button>}
        </div>
        <div style={{display:"flex",alignItems:"center",gap:"12px"}}>
          <span onClick={resetProfile} style={{fontFamily:SANS,fontSize:"13px",color:T.textDim,cursor:"pointer"}} title="Click to reset profile">{user.name}</span>
          <XPBadge xp={user.xp}/>
        </div>
      </div>

      <div style={{maxWidth:"640px",margin:"0 auto",padding:"20px"}}>

        {/* HOME */}
        {mode==="home" && <div className="fade-in">
          <div style={{textAlign:"center",marginBottom:"28px",paddingTop:"12px"}}>
            <h2 style={{fontFamily:SERIF,fontSize:"24px",color:T.gold,margin:"0 0 4px 0"}}>Welcome back, {user.name}</h2>
            <p style={{fontFamily:SANS,fontSize:"13px",color:T.textDim}}>Total XP: <strong style={{color:T.gold}}>{user.xp}</strong> Â· Sessions: {user.sessions}</p>
          </div>
          <div style={{display:"grid",gap:"12px"}}>

            <Card style={{cursor:"pointer"}} onClick={()=>{setGameQs(generateDeclensionQuestions(10));setCompletion(null);setMode("declension");}}>
              <div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}>
                <div><p style={{fontFamily:SERIF,fontSize:"20px",color:T.text,margin:"0 0 4px 0"}}>ğŸ› Declension Arena</p>
                  <p style={{fontFamily:SANS,fontSize:"13px",color:T.textDim,margin:0}}>Identify cases across 1st, 2nd, and 3rd declensions</p></div>
                <span style={{fontFamily:SANS,fontSize:"12px",color:T.goldDim}}>10 XP â†’</span>
              </div>
            </Card>

            <Card>
              <p style={{fontFamily:SERIF,fontSize:"20px",color:T.text,margin:"0 0 8px 0"}}>ğŸ”¥ Verb Forge</p>
              <p style={{fontFamily:SANS,fontSize:"13px",color:T.textDim,margin:"0 0 12px 0"}}>Conjugation challenges â€” choose your tenses</p>
              <div style={{display:"flex",flexWrap:"wrap",gap:"8px"}}>
                {TENSES.map(t=><Btn key={t} variant="default" onClick={()=>{setGameQs(generateVerbQuestions(10,[t]));setCompletion(null);setMode("verbs");}} style={{fontSize:"12px",padding:"8px 14px",textTransform:"capitalize"}}>{t}</Btn>)}
                <Btn variant="gold" onClick={()=>{setGameQs(generateVerbQuestions(10,TENSES));setCompletion(null);setMode("verbs");}} style={{fontSize:"12px",padding:"8px 14px"}}>âš¡ ALL TENSES</Btn>
              </div>
            </Card>

            <Card>
              <p style={{fontFamily:SERIF,fontSize:"20px",color:T.text,margin:"0 0 8px 0"}}>ğŸ“œ Story Quest</p>
              <p style={{fontFamily:SANS,fontSize:"13px",color:T.textDim,margin:"0 0 12px 0"}}>The Horatii and Curiatii â€” grammar meets narrative</p>
              <div style={{display:"grid",gap:"6px"}}>
                {STORY_CHAPTERS.map((ch,i)=>
                  <button key={i} onClick={()=>{setGameQs(ch.questions.map(q=>({...q,prompt:q.q})));setSubMode(i);setCompletion(null);setMode("story");}}
                    style={{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"10px 14px",background:T.surfaceLight,border:"1px solid "+T.border,borderRadius:"6px",color:T.text,fontFamily:SANS,fontSize:"13px",cursor:"pointer",textAlign:"left"}}>
                    <span>Ch. {i+1}: {ch.title}</span>
                    <span style={{color:T.textMuted,fontSize:"12px"}}>{ch.questions.length} Qs â†’</span>
                  </button>
                )}
              </div>
            </Card>

            <Card style={{cursor:"pointer",background:T.crimsonDark+"30",border:"1px solid "+T.crimson+"40"}}
              onClick={()=>{setGameQs(generateBossQuestions(8));setCompletion(null);setMode("boss");}}>
              <div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}>
                <div><p style={{fontFamily:SERIF,fontSize:"20px",color:T.crimsonLight,margin:"0 0 4px 0"}}>âš” Boss Round</p>
                  <p style={{fontFamily:SANS,fontSize:"13px",color:T.textDim,margin:0}}>Mixed challenges â€” grammar, translation, story. <strong style={{color:T.gold}}>2Ã— XP!</strong></p></div>
                <span style={{fontFamily:SANS,fontSize:"12px",color:T.crimsonLight}}>20 XP â†’</span>
              </div>
            </Card>

            <Card style={{cursor:"pointer"}} onClick={()=>setMode("leaderboard")}>
              <div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}>
                <div><p style={{fontFamily:SERIF,fontSize:"20px",color:T.gold,margin:"0 0 4px 0"}}>ğŸ† Leaderboard</p>
                  <p style={{fontFamily:SANS,fontSize:"13px",color:T.textDim,margin:0}}>See who leads â€” top 5 get the 5% exam bonus</p></div>
                <span style={{color:T.goldDim,fontSize:"20px"}}>â†’</span>
              </div>
            </Card>
          </div>
        </div>}

        {/* GAME MODES */}
        {mode==="declension" && gameQs && <QuizEngine questions={gameQs} title="Declension Arena" icon="ğŸ›" onComplete={handleComplete}/>}
        {mode==="verbs" && gameQs && <QuizEngine questions={gameQs} title="Verb Forge" icon="ğŸ”¥" onComplete={handleComplete}/>}
        {mode==="story" && gameQs && <div>
          {subMode!==null && <Card style={{marginBottom:"16px",background:T.blue+"10",border:"1px solid "+T.blue+"30"}} className="fade-in">
            <p style={{fontFamily:SERIF,fontSize:"16px",color:T.gold,marginBottom:"8px"}}>Chapter {subMode+1}: {STORY_CHAPTERS[subMode].title}</p>
            <p style={{fontFamily:SERIF,fontSize:"15px",color:T.textDim,fontStyle:"italic",lineHeight:"1.6",marginBottom:"8px"}}>{STORY_CHAPTERS[subMode].latin}</p>
            <details style={{cursor:"pointer"}}><summary style={{fontFamily:SANS,fontSize:"12px",color:T.textMuted}}>â–¶ Show translation</summary>
              <p style={{fontFamily:SANS,fontSize:"13px",color:T.textDim,marginTop:"8px",lineHeight:"1.5"}}>{STORY_CHAPTERS[subMode].translation}</p>
            </details>
          </Card>}
          <QuizEngine questions={gameQs} title={"Story Quest â€” Ch."+(subMode!==null?subMode+1:"")} icon="ğŸ“œ" onComplete={handleComplete} xpPerCorrect={15}/>
        </div>}
        {mode==="boss" && gameQs && <QuizEngine questions={gameQs} title="Boss Round" icon="âš”" onComplete={handleComplete} xpPerCorrect={20} streakBonus={10} perfectBonus={100}/>}

        {/* LEADERBOARD */}
        {mode==="leaderboard" && <Leaderboard currentUser={user}/>}
      </div>
    </div>
  );
}

ReactDOM.render(<App/>, document.getElementById("root"));
</script>
</body>
</html>
